<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bookr</title>
  <link rel="icon" type="image/svg+xml" href="/bookr-icon.svg" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f8f7f4;
      --surface: #ffffff;
      --border: #e2ded8;
      --accent: #4f46e5;
      --accent-hover: #4338ca;
      --accent-light: #eef2ff;
      --text: #1c1917;
      --muted: #78716c;
      --danger: #dc2626;
      --danger-light: #fef2f2;
      --success: #16a34a;
      --success-light: #f0fdf4;
      --radius: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,.08), 0 2px 4px -2px rgba(0,0,0,.06);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 60px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text);
    }
    .logo svg { color: var(--accent); }
    .header-actions { display: flex; gap: 8px; align-items: center; }
    #statusBadge {
      font-size: .75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-light);
      color: var(--accent);
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
    main { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }

    /* ‚îÄ‚îÄ Upload zone ‚îÄ‚îÄ */
    .upload-section { margin-bottom: 40px; }

    #dropZone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      padding: 48px 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      position: relative;
    }
    #dropZone:hover, #dropZone.drag-over {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    #dropZone .upload-icon {
      width: 52px; height: 52px;
      margin: 0 auto 16px;
      color: var(--accent);
    }
    #dropZone p { color: var(--muted); margin-top: 6px; font-size: .9rem; }
    #dropZone .upload-label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    .btn-browse {
      display: inline-block;
      margin-top: 16px;
      padding: 9px 20px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: .9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
    }
    .btn-browse:hover { background: var(--accent-hover); }
    #fileInput { display: none; }

    /* ‚îÄ‚îÄ Scanning overlay ‚îÄ‚îÄ */
    #scanOverlay {
      display: none;
      border: 2px solid var(--accent);
      border-radius: var(--radius);
      background: var(--accent-light);
      padding: 48px 24px;
      text-align: center;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #scanStatus { font-weight: 600; color: var(--accent); }
    #scanSub { color: var(--muted); font-size: .875rem; margin-top: 4px; }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 18px;
      border-radius: 8px;
      font-size: .9rem;
      font-weight: 500;
      box-shadow: var(--shadow-md);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .25s, transform .25s;
      pointer-events: none;
      z-index: 100;
      max-width: 320px;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.success { background: var(--success-light); color: var(--success); border: 1px solid #bbf7d0; }
    #toast.error   { background: var(--danger-light);  color: var(--danger);  border: 1px solid #fecaca; }
    #toast.info    { background: var(--accent-light);  color: var(--accent);  border: 1px solid #c7d2fe; }

    /* ‚îÄ‚îÄ Library section ‚îÄ‚îÄ */
    .library-header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    .library-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      flex: 1 1 auto;
    }
    #bookCount {
      background: var(--accent);
      color: #fff;
      font-size: .75rem;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 999px;
      vertical-align: middle;
      margin-left: 6px;
    }

    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    #searchInput {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 7px;
      font-size: .9rem;
      width: 220px;
      background: var(--surface);
      color: var(--text);
      outline: none;
      transition: border-color .15s;
    }
    #searchInput:focus { border-color: var(--accent); }

    .btn-outline {
      padding: 8px 14px;
      border: 1px solid var(--border);
      border-radius: 7px;
      background: var(--surface);
      font-size: .875rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--text);
      transition: border-color .15s, background .15s;
    }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

    /* ‚îÄ‚îÄ Book grid ‚îÄ‚îÄ */
    #bookGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }

    .book-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: box-shadow .2s, transform .2s;
      position: relative;
    }
    .book-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }

    .book-cover {
      width: 100%;
      aspect-ratio: 2/3;
      background: #0d0d0d;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .book-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .book-cover .no-cover {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 16px 10px;
      text-align: center;
      background: #0d0d0d;
      color: #c9a84c;
      position: relative;
      box-sizing: border-box;
      gap: 0;
    }
    .book-cover .no-cover::before,
    .book-cover .no-cover::after {
      content: '';
      position: absolute;
      left: 0; right: 0;
      height: 3px;
      background: #c9a84c;
    }
    .book-cover .no-cover::before { top: 0; }
    .book-cover .no-cover::after  { bottom: 0; }
    .book-cover .no-cover .nc-series {
      font-size: .46rem;
      letter-spacing: .2em;
      text-transform: uppercase;
      font-weight: 700;
      opacity: .65;
      margin-bottom: 8px;
    }
    .book-cover .no-cover .nc-rule {
      width: 28px;
      height: 1px;
      background: currentColor;
      opacity: .35;
      margin: 0 auto 10px;
    }
    .book-cover .no-cover span {
      font-size: .72rem;
      font-weight: 700;
      word-break: break-word;
      color: #f0f0f0;
      line-height: 1.4;
      letter-spacing: .01em;
    }
    .book-cover .no-cover .nc-author {
      margin-top: 8px;
      font-size: .58rem;
      color: #c9a84c;
      opacity: .7;
      font-style: italic;
      word-break: break-word;
    }

    .book-info {
      padding: 10px 10px 12px;
    }
    .book-title {
      font-size: .82rem;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 3px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .book-author {
      font-size: .75rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .book-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
    }
    .book-year {
      font-size: .7rem;
      color: var(--muted);
      background: var(--bg);
      padding: 1px 6px;
      border-radius: 4px;
    }
    .book-isbn {
      font-size: .65rem;
      color: var(--muted);
      opacity: .7;
    }
    .delete-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px; height: 24px;
      background: rgba(255,255,255,.9);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity .15s, background .15s;
      font-size: .85rem;
      color: var(--danger);
      line-height: 1;
    }
    .book-card:hover .delete-btn { opacity: 1; }
    .delete-btn:hover { background: var(--danger-light); border-color: var(--danger); }

    /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
    #emptyState {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    #emptyState svg { width: 56px; height: 56px; margin: 0 auto 16px; opacity: .3; }
    #emptyState p { font-size: 1rem; font-weight: 500; }
    #emptyState small { font-size: .85rem; }

    /* ‚îÄ‚îÄ Config warning ‚îÄ‚îÄ */
    #configWarning {
      display: none;
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: var(--radius);
      padding: 14px 18px;
      margin-bottom: 24px;
      font-size: .875rem;
      color: #92400e;
    }
    #configWarning strong { display: block; margin-bottom: 4px; }

    /* ‚îÄ‚îÄ Section tabs ‚îÄ‚îÄ */
    .section-tabs { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 24px; }
    .section-tab {
      padding: 5px 14px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--surface);
      font-size: .82rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--muted);
      transition: all .15s;
    }
    .section-tab:hover { border-color: var(--accent); color: var(--accent); }
    .section-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .book-section {
      font-size: .65rem;
      color: var(--accent);
      background: var(--accent-light);
      padding: 1px 5px;
      border-radius: 3px;
      margin-top: 4px;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ‚îÄ‚îÄ Wishlist cards ‚îÄ‚îÄ */
    .book-card.wishlist {
      border: 2px dashed #d4ccc6;
      background: #f5f4f0;
    }
    .book-card.wishlist .book-cover img {
      filter: grayscale(25%) opacity(0.88);
    }
    .wishlist-actions { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
    .btn-own-it {
      padding: 5px 8px;
      background: var(--success);
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: .75rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: background .15s;
    }
    .btn-own-it:hover { background: #15803d; }
    .btn-wob {
      padding: 5px 8px;
      background: var(--surface);
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: .75rem;
      font-weight: 500;
      text-align: center;
      text-decoration: none;
      display: block;
      transition: border-color .15s, color .15s;
    }
    .btn-wob:hover { border-color: var(--accent); color: var(--accent); }

    /* ‚îÄ‚îÄ Owned filter ‚îÄ‚îÄ */
    .owned-tabs {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 7px;
      overflow: hidden;
      background: var(--surface);
    }
    .owned-tab {
      padding: 7px 12px;
      background: none;
      border: none;
      border-right: 1px solid var(--border);
      font-size: .82rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--muted);
      transition: background .15s, color .15s;
    }
    .owned-tab:last-child { border-right: none; }
    .owned-tab:hover { background: var(--accent-light); color: var(--accent); }
    .owned-tab.active { background: var(--accent); color: #fff; }

    /* ‚îÄ‚îÄ Book card clickable ‚îÄ‚îÄ */
    .book-card { cursor: pointer; }

    /* ‚îÄ‚îÄ Shelf badge on card ‚îÄ‚îÄ */
    .shelf-badge {
      display: inline-block;
      font-size: .62rem;
      color: var(--muted);
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 1px 6px;
      border-radius: 999px;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 24px;
    }
    .modal {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      max-width: 680px;
      width: 100%;
      display: flex;
      gap: 0;
      position: relative;
      overflow: hidden;
      max-height: 90vh;
    }
    .modal-cover {
      flex: 0 0 180px;
      width: 180px;
      min-height: 270px;
      background: #0d0d0d;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .modal-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .modal-body {
      flex: 1;
      padding: 24px 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 1.15rem;
      font-weight: 700;
      line-height: 1.3;
      padding-right: 28px;
    }
    .modal-author { font-size: .9rem; color: var(--muted); }
    .modal-meta { font-size: .8rem; color: var(--muted); }
    .modal-isbn { font-size: .75rem; color: var(--muted); opacity: .75; }
    .modal-desc {
      font-size: .85rem;
      line-height: 1.6;
      color: var(--text);
      margin-top: 4px;
      flex: 1;
    }
    .shelf-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .shelf-row label {
      font-size: .8rem;
      color: var(--muted);
      white-space: nowrap;
    }
    .shelf-field {
      flex: 1;
      padding: 5px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: .82rem;
      color: var(--text);
      background: var(--bg);
      outline: none;
      transition: border-color .15s;
    }
    .shelf-field:focus { border-color: var(--accent); background: var(--surface); }
    .modal-links {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .modal-link-btn {
      padding: 5px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      font-size: .78rem;
      font-weight: 500;
      color: var(--muted);
      text-decoration: none;
      cursor: pointer;
      transition: border-color .15s, color .15s;
    }
    .modal-link-btn:hover { border-color: var(--accent); color: var(--accent); }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 28px; height: 28px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 50%;
      font-size: 1rem;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: background .15s, color .15s;
      z-index: 1;
    }
    .modal-close:hover { background: var(--danger-light); color: var(--danger); border-color: var(--danger); }

    @media (max-width: 600px) {
      main { padding: 20px 16px; }
      #bookGrid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
      .controls { width: 100%; }
      #searchInput { flex: 1; }
      .modal { flex-direction: column; }
      .modal-cover { flex: 0 0 auto; width: 100%; min-height: 200px; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="/bookr-icon.svg" width="28" height="28" alt="Bookr" style="border-radius:6px" />
    Bookr
  </div>
  <div class="header-actions">
    <span id="statusBadge">Loading‚Ä¶</span>
  </div>
</header>

<main>
  <div id="configWarning">
    <strong>‚ö†Ô∏è No vision backend configured</strong>
    Set <code>OPENAI_API_KEY</code> or <code>USE_OLLAMA=true</code> in your <code>.env</code> file and restart the server.
  </div>

  <!-- Upload zone -->
  <section class="upload-section">
    <div id="dropZone">
      <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/>
        <path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/>
      </svg>
      <p class="upload-label">Drop a bookshelf photo here</p>
      <p>Supports JPG, PNG, WEBP ‚Äî single shelf or stacked books</p>
      <label for="fileInput" class="btn-browse">Choose photo</label>
      <input type="file" id="fileInput" accept="image/*" />
    </div>

    <div id="scanOverlay">
      <div class="spinner"></div>
      <p id="scanStatus">Scanning bookshelf‚Ä¶</p>
      <p id="scanSub">This may take 10‚Äì30 seconds</p>
    </div>
  </section>

  <!-- Section tabs -->
  <div id="sectionsBar" style="display:none">
    <div class="section-tabs" id="sectionTabs">
      <button class="section-tab active" data-section="" onclick="setSection(this, '')">All</button>
    </div>
  </div>

  <!-- Library -->
  <section>
    <div class="library-header">
      <h2>My Library <span id="bookCount">0</span></h2>
      <div class="controls">
        <input type="search" id="searchInput" placeholder="Search title or author‚Ä¶" />
        <div class="owned-tabs">
          <button class="owned-tab active" onclick="setOwned(this, null)">All</button>
          <button class="owned-tab" onclick="setOwned(this, 1)">Owned</button>
          <button class="owned-tab" onclick="setOwned(this, 0)">Wishlist</button>
        </div>
        <button class="btn-outline" onclick="exportFile('csv')">Export CSV</button>
        <button class="btn-outline" onclick="exportFile('json')">Export JSON</button>
      </div>
    </div>
    <div id="bookGrid">
      <div id="emptyState">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
        </svg>
        <p>Your library is empty</p>
        <small>Upload a bookshelf photo to get started</small>
      </div>
    </div>
  </section>
</main>

<div id="toast"></div>

<!-- Book detail modal -->
<div id="bookModal" class="modal-overlay" style="display:none" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-cover" id="modalCover"></div>
    <div class="modal-body">
      <h2 class="modal-title" id="modalTitle"></h2>
      <div class="modal-author" id="modalAuthor"></div>
      <div class="modal-meta" id="modalMeta"></div>
      <div class="modal-isbn" id="modalIsbn"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div class="shelf-row">
        <label for="shelfField">üìç Shelf</label>
        <input type="text" id="shelfField" class="shelf-field" placeholder="e.g. Living room, top shelf" />
      </div>
      <div class="modal-links" id="modalLinks"></div>
    </div>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>
</div>

<script>
  const API = '';
  let searchTimer;
  let currentSection = '';
  let currentOwned = null;
  let booksCache = new Map();

  // ‚îÄ‚îÄ Health check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function checkHealth() {
    try {
      const res = await fetch(`${API}/api/health`);
      const data = await res.json();
      const badge = document.getElementById('statusBadge');
      if (data.vision_backend === 'none') {
        badge.textContent = '‚ö† No vision backend';
        badge.style.background = '#fef9c3';
        badge.style.color = '#854d0e';
        document.getElementById('configWarning').style.display = 'block';
      } else {
        const labels = { claude: '‚ú¶ Claude', openai: '‚ú¶ OpenAI', ollama: 'ü¶ô Ollama' };
        badge.textContent = labels[data.vision_backend] || data.vision_backend;
      }
    } catch {
      document.getElementById('statusBadge').textContent = '‚ö† Offline';
    }
  }

  // ‚îÄ‚îÄ Drag & drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) uploadFile(file);
    else showToast('Please drop an image file', 'error');
  });
  fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) uploadFile(fileInput.files[0]);
    fileInput.value = '';
  });

  // ‚îÄ‚îÄ Upload & scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function uploadFile(file) {
    showScanning(true, `Analysing "${file.name}"‚Ä¶`);
    const form = new FormData();
    form.append('file', file);
    try {
      const res = await fetch(`${API}/api/scan`, { method: 'POST', body: form });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Scan failed');
      if (data.books_added === 0) {
        showToast(`No books detected in this image. Try a clearer photo.`, 'info');
      } else {
        showToast(`‚úì Added ${data.books_added} book${data.books_added !== 1 ? 's' : ''} (${data.detected} detected)`, 'success');
      }
      loadBooks();
    } catch (err) {
      showToast(err.message, 'error');
    } finally {
      showScanning(false);
    }
  }

  function showScanning(on, label = 'Scanning bookshelf‚Ä¶') {
    dropZone.style.display = on ? 'none' : '';
    document.getElementById('scanOverlay').style.display = on ? '' : 'none';
    document.getElementById('scanStatus').textContent = label;
  }

  // ‚îÄ‚îÄ Sections ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadSections() {
    try {
      const res = await fetch(`${API}/api/sections`);
      const data = await res.json();
      if (!data.sections.length) return;
      const bar = document.getElementById('sectionsBar');
      const tabs = document.getElementById('sectionTabs');
      data.sections.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'section-tab';
        btn.dataset.section = s;
        btn.textContent = s;
        btn.onclick = () => setSection(btn, s);
        tabs.appendChild(btn);
      });
      bar.style.display = '';
    } catch {}
  }

  function setSection(btn, section) {
    currentSection = section;
    document.querySelectorAll('.section-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadBooks(document.getElementById('searchInput').value);
  }

  function setOwned(btn, owned) {
    currentOwned = owned;
    document.querySelectorAll('.owned-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadBooks(document.getElementById('searchInput').value);
  }

  async function toggleOwned(id) {
    await fetch(`${API}/api/books/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ owned: 1 }),
    });
    showToast('‚úì Added to your library!', 'success');
    loadBooks(document.getElementById('searchInput').value);
  }

  // ‚îÄ‚îÄ Library ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadBooks(q = '') {
    const params = new URLSearchParams();
    if (q) params.set('q', q);
    if (currentSection) params.set('section', currentSection);
    if (currentOwned !== null) params.set('owned', currentOwned);
    const url = `${API}/api/books${params.toString() ? '?' + params : ''}`;
    const res = await fetch(url);
    const data = await res.json();
    renderBooks(data.books, data.total);
  }

  function renderBooks(books, total) {
    const grid = document.getElementById('bookGrid');
    document.getElementById('bookCount').textContent = total;

    // Rebuild cache
    booksCache = new Map();
    books.forEach(b => booksCache.set(b.id, b));

    if (!books.length) {
      grid.innerHTML = `
        <div id="emptyState">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          </svg>
          <p>${total === 0 ? 'Your library is empty' : 'No results found'}</p>
          <small>${total === 0 ? 'Upload a bookshelf photo to get started' : 'Try a different search'}</small>
        </div>`;
      return;
    }

    grid.innerHTML = books.map(book => {
      const isWishlist = book.owned === 0;
      const wobQuery = encodeURIComponent((book.title || '') + (book.author ? ' ' + book.author : ''));
      const wobUrl = `https://www.worldofbooks.com/en-gb/search?keyword=${wobQuery}`;
      return `
        <div class="book-card${isWishlist ? ' wishlist' : ''}" data-id="${book.id}" onclick="openModal(${book.id})">
          <div class="book-cover">
            ${book.cover_url
              ? `<img src="${book.cover_url}" alt="${escAttr(book.title)}" loading="lazy" data-title="${escAttr(book.title)}" data-section="${escAttr(book.section||'')}" data-author="${escAttr(book.author||'')}" onerror="this.closest('.book-cover').innerHTML=noCoverHTML(this.dataset.title,this.dataset.section,this.dataset.author)">`
              : noCoverHTML(book.title, book.section||'', book.author||'')}
          </div>
          <div class="book-info">
            <div class="book-title" title="${escAttr(book.title)}">${escHtml(book.title)}</div>
            <div class="book-author">${escHtml(book.author || '‚Äî')}</div>
            <div class="book-meta">
              ${book.publish_year ? `<span class="book-year">${book.publish_year}</span>` : '<span></span>'}
              ${book.isbn ? `<span class="book-isbn">ISBN</span>` : ''}
            </div>
            ${book.section ? `<span class="book-section">${escHtml(book.section)}</span>` : ''}
            ${book.shelf_location ? `<span class="shelf-badge">üìç ${escHtml(book.shelf_location)}</span>` : ''}
            ${isWishlist ? `
            <div class="wishlist-actions">
              <button class="btn-own-it" onclick="event.stopPropagation();toggleOwned(${book.id})">‚úì I own this</button>
              <a class="btn-wob" href="${wobUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Buy on WoB</a>
            </div>` : ''}
          </div>
          <button class="delete-btn" onclick="event.stopPropagation();deleteBook(${book.id})" title="Remove">‚úï</button>
        </div>`;
    }).join('');
  }

  function noCoverHTML(title, section, author) {
    const ser = escHtml(section || 'Bookr');
    return `<div class="no-cover">
      <div class="nc-series">${ser}</div>
      <div class="nc-rule"></div>
      <span>${escHtml(title)}</span>
      ${author ? `<div class="nc-author">${escHtml(author)}</div>` : ''}
    </div>`;
  }

  // ‚îÄ‚îÄ Delete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function deleteBook(id) {
    if (!confirm('Remove this book from your library?')) return;
    await fetch(`${API}/api/books/${id}`, { method: 'DELETE' });
    const card = document.querySelector(`.book-card[data-id="${id}"]`);
    if (card) { card.style.opacity = '0'; card.style.transform = 'scale(.95)'; card.style.transition = '.2s'; setTimeout(() => loadBooks(document.getElementById('searchInput').value), 200); }
  }

  // ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('searchInput').addEventListener('input', e => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => loadBooks(e.target.value), 300);
  });

  // ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function exportFile(format) {
    window.location.href = `${API}/api/export/${format}`;
  }

  // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let toastTimer;
  function showToast(msg, type = 'info') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `show ${type}`;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.className = '', 4000);
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function escAttr(s) { return escHtml(s); }

  // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let modalBookId = null;

  function openModal(id) {
    const book = booksCache.get(id);
    if (!book) return;
    modalBookId = id;

    // Cover
    const coverEl = document.getElementById('modalCover');
    if (book.cover_url) {
      coverEl.innerHTML = `<img src="${escAttr(book.cover_url)}" alt="${escAttr(book.title)}" style="width:100%;height:100%;object-fit:cover" onerror="this.closest('.modal-cover').innerHTML=noCoverHTML(${JSON.stringify(book.title)},${JSON.stringify(book.section||'')},${JSON.stringify(book.author||'')})" />`;
    } else {
      coverEl.innerHTML = noCoverHTML(book.title, book.section||'', book.author||'');
    }

    document.getElementById('modalTitle').textContent = book.title || '';
    document.getElementById('modalAuthor').textContent = book.author || '';

    const metaParts = [];
    if (book.publish_year) metaParts.push(book.publish_year);
    if (book.publisher) metaParts.push(book.publisher);
    document.getElementById('modalMeta').textContent = metaParts.join(' ¬∑ ');

    document.getElementById('modalIsbn').textContent = book.isbn ? `ISBN: ${book.isbn}` : '';
    document.getElementById('modalDesc').textContent = book.description || '‚Äî';

    const shelfField = document.getElementById('shelfField');
    shelfField.value = book.shelf_location || '';
    shelfField.onblur = () => saveShelfLocation(id, shelfField.value.trim());
    shelfField.onkeydown = e => { if (e.key === 'Enter') { shelfField.blur(); } };

    // Links
    const wobQuery = encodeURIComponent((book.title || '') + (book.author ? ' ' + book.author : ''));
    const goodreadsUrl = `https://www.goodreads.com/search?q=${encodeURIComponent((book.title || '') + ' ' + (book.author || ''))}`;
    let linksHtml = `<a class="modal-link-btn" href="${goodreadsUrl}" target="_blank" rel="noopener">Goodreads</a>`;
    if (book.open_library_key) {
      linksHtml += `<a class="modal-link-btn" href="https://openlibrary.org${escAttr(book.open_library_key)}" target="_blank" rel="noopener">Open Library</a>`;
    }
    linksHtml += `<a class="modal-link-btn" href="https://www.worldofbooks.com/en-gb/search?keyword=${wobQuery}" target="_blank" rel="noopener">World of Books</a>`;
    document.getElementById('modalLinks').innerHTML = linksHtml;

    document.getElementById('bookModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('bookModal').style.display = 'none';
    modalBookId = null;
  }

  async function saveShelfLocation(id, val) {
    const res = await fetch(`${API}/api/books/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ shelf_location: val }),
    });
    if (!res.ok) return;
    const updated = await res.json();
    // Update cache
    if (booksCache.has(id)) {
      booksCache.get(id).shelf_location = val;
    }
    // Update badge on card
    const card = document.querySelector(`.book-card[data-id="${id}"]`);
    if (card) {
      const info = card.querySelector('.book-info');
      let badge = card.querySelector('.shelf-badge');
      if (val) {
        if (badge) {
          badge.textContent = 'üìç ' + val;
        } else {
          badge = document.createElement('span');
          badge.className = 'shelf-badge';
          badge.textContent = 'üìç ' + val;
          // Insert after .book-section if present, else after last child of book-info
          const section = info.querySelector('.book-section');
          if (section) section.after(badge);
          else info.appendChild(badge);
        }
      } else if (badge) {
        badge.remove();
      }
    }
  }

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  checkHealth();
  loadSections();
  loadBooks();
</script>
</body>
</html>
